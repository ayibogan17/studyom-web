generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                             String                     @id @default(cuid())
  email                          String                     @unique
  name                           String?
  role                           UserRole                   @default(USER)
  createdAt                      DateTime                   @default(now())
  updatedAt                      DateTime                   @updatedAt
  emailVerified                  DateTime?
  image                          String?
  passwordHash                   String?
  city                           String?
  fullName                       String?
  intent                         String[]
  isProducer                     Boolean                    @default(false)
  isStudioOwner                  Boolean                    @default(false)
  isTeacher                      Boolean                    @default(false)
  isDisabled                     Boolean                    @default(false)
  phone                          String?
  roles                          String[]                   @default([])
  isSuspended                    Boolean                    @default(false)
  isBanned                       Boolean                    @default(false)
  banReason                      String?
  adminNote                      String?
  accounts                       Account[]
  contactEvents                  ContactEvent[]
  producerMessagesSent           ProducerMessageRequest[]   @relation("ProducerMessageFrom")
  producerMessagesReceived       ProducerMessageRequest[]   @relation("ProducerMessageTo")
  producerStudioLinks            ProducerStudioLink[]
  producerThreadsAsProducer      ProducerThread[]           @relation("ProducerThreadProducer")
  producerThreadsAsStudent       ProducerThread[]           @relation("ProducerThreadStudent")
  sessions                       Session[]
  studios                        Studio[]
  studioCalendarBlocksCreated    StudioCalendarBlock[]      @relation("StudioCalendarBlockCreator")
  studioContactEvents            StudioContactEvent[]
  happyHourSlotsCreated          StudioHappyHourSlot[]      @relation("StudioHappyHourCreator")
  studioReservationRequests      StudioReservationRequest[]
  studioThreadsAsStudent         StudioThread[]             @relation("StudioThreadStudent")
  teacherMessageRequestsSent     TeacherMessageRequest[]    @relation("TeacherMessageRequestStudent")
  teacherMessageRequestsReceived TeacherMessageRequest[]    @relation("TeacherMessageRequestTeacher")
  teacherStudioLinks             TeacherStudioLink[]
  teacherThreadsAsStudent        TeacherThread[]            @relation("TeacherThreadStudent")
  teacherThreadsAsTeacher        TeacherThread[]            @relation("TeacherThreadTeacher")
  openJamJams                    OpenJam[]
  openJamParticipants            OpenJamParticipant[]
  openJamMessages                OpenJamMessage[]
  openJamMemories                OpenJamMemory[]
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  oauth_token_secret String?
  oauth_token        String?
  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())

  @@unique([identifier, token])
}

model Studio {
  id                              String                     @id @default(cuid())
  name                            String
  city                            String?
  district                        String?
  address                         String?
  ownerEmail                      String
  phone                           String?
  createdAt                       DateTime                   @default(now())
  updatedAt                       DateTime                   @updatedAt
  openingHours                    Json?
  isActive                        Boolean                    @default(true)
  coverImageUrl                   String?
  slug                            String?                    @unique
  applicationStatus               String                     @default("pending")
  applicationAdminNote            String?
  applicationAdminTags            String[]                   @default([])
  applicationRejectReason         String?
  applicationChangesRequestedNote String?
  visibilityStatus                String                     @default("published")
  moderationNote                  String?
  complaintsCount                 Int                        @default(0)
  flagsCount                      Int                        @default(0)
  notifications                   Notification[]
  producerStudioLinks             ProducerStudioLink[]
  ratings                         Rating[]
  rooms                           Room[]
  owner                           User                       @relation(fields: [ownerEmail], references: [email])
  calendarBlocks                  StudioCalendarBlock[]
  calendarSettings                StudioCalendarSettings?
  contactEvents                   StudioContactEvent[]
  happyHourSlots                  StudioHappyHourSlot[]
  reservationRequests             StudioReservationRequest[]
  studioThreads                   StudioThread[]
  teacherStudioLinks              TeacherStudioLink[]
  openJamJams                     OpenJam[]
}

model Room {
  id                  String                     @id @default(cuid())
  name                String
  type                String
  color               String?
  pricingModel        PricingModel               @default(FLAT)
  flatRate            String?
  minRate             String?
  dailyRate           String?
  hourlyRate          String?
  studioId            String
  createdAt           DateTime                   @default(now())
  updatedAt           DateTime                   @updatedAt
  equipmentJson       Json?
  extrasJson          Json?
  featuresJson        Json?
  imagesJson          Json?
  order               Int                        @default(0)
  happyHourRate       String?
  studio              Studio                     @relation(fields: [studioId], references: [id], onDelete: Cascade)
  slots               Slot[]
  calendarBlocks      StudioCalendarBlock[]
  happyHourSlots      StudioHappyHourSlot[]
  reservationRequests StudioReservationRequest[]
}

model Slot {
  id           String     @id @default(cuid())
  date         DateTime
  timeLabel    String
  status       SlotStatus @default(EMPTY)
  customerName String?
  roomId       String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  room         Room       @relation(fields: [roomId], references: [id], onDelete: Cascade)
}

model StudioCalendarSettings {
  id                  String   @id @default(cuid())
  studioId            String   @unique
  timezone            String   @default("Europe/Istanbul")
  slotStepMinutes     Int      @default(60)
  dayCutoffHour       Int      @default(4)
  weeklyHours         Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  happyHourEnabled    Boolean  @default(false)
  bookingApprovalMode String   @default("manual")
  bookingCutoffUnit   String?
  bookingCutoffValue  Int?
  studio              Studio   @relation(fields: [studioId], references: [id], onDelete: Cascade)
}

model StudioCalendarBlock {
  id                 String                    @id @default(cuid())
  studioId           String
  roomId             String
  startAt            DateTime
  endAt              DateTime
  type               String
  status             String?
  note               String?
  createdByUserId    String?
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @updatedAt
  title              String?
  createdByUser      User?                     @relation("StudioCalendarBlockCreator", fields: [createdByUserId], references: [id])
  room               Room                      @relation(fields: [roomId], references: [id], onDelete: Cascade)
  studio             Studio                    @relation(fields: [studioId], references: [id], onDelete: Cascade)
  reservationRequest StudioReservationRequest? @relation("ReservationRequestBlock")

  @@index([studioId, roomId, startAt])
  @@index([roomId, startAt])
}

model StudioReservationRequest {
  id              String               @id @default(cuid())
  studioId        String
  roomId          String
  studentUserId   String?
  requesterName   String
  requesterPhone  String
  requesterEmail  String?
  note            String?
  startAt         DateTime
  endAt           DateTime
  hours           Int
  totalPrice      Float?
  currency        String?              @default("TRY")
  status          String               @default("pending")
  userUnread      Boolean              @default(true)
  studioUnread    Boolean              @default(true)
  calendarBlockId String?              @unique
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  calendarBlock   StudioCalendarBlock? @relation("ReservationRequestBlock", fields: [calendarBlockId], references: [id])
  room            Room                 @relation(fields: [roomId], references: [id], onDelete: Cascade)
  studentUser     User?                @relation(fields: [studentUserId], references: [id])
  studio          Studio               @relation(fields: [studioId], references: [id], onDelete: Cascade)

  @@index([studioId, createdAt])
  @@index([roomId, startAt])
  @@index([studentUserId, updatedAt])
}

model StudioHappyHourSlot {
  id              String   @id @default(cuid())
  studioId        String
  roomId          String
  startAt         DateTime
  endAt           DateTime
  createdByUserId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdByUser   User?    @relation("StudioHappyHourCreator", fields: [createdByUserId], references: [id])
  room            Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  studio          Studio   @relation(fields: [studioId], references: [id], onDelete: Cascade)

  @@unique([roomId, startAt, endAt])
  @@index([studioId, roomId, startAt])
  @@index([roomId, startAt])
}

model Notification {
  id        String   @id @default(cuid())
  message   String
  studioId  String
  createdAt DateTime @default(now())
  isRead    Boolean  @default(false)
  studio    Studio   @relation(fields: [studioId], references: [id], onDelete: Cascade)
}

model Rating {
  id        String   @id @default(cuid())
  value     Float
  comment   String?
  studioId  String
  createdAt DateTime @default(now())
  studio    Studio   @relation(fields: [studioId], references: [id], onDelete: Cascade)
}

model TeacherApplication {
  id                   Int      @id @default(autoincrement())
  userId               String
  data                 Json
  status               String
  createdAt            DateTime @default(now())
  adminNote            String?
  adminTags            String[] @default([])
  rejectReason         String?
  changesRequestedNote String?
  visibilityStatus     String   @default("published")
  moderationNote       String?
  complaintsCount      Int      @default(0)
  flagsCount           Int      @default(0)
  updatedAt            DateTime @updatedAt

  @@map("TeacherApplication")
}

model ProducerApplication {
  id                   Int      @id @default(autoincrement())
  userId               String
  data                 Json
  status               String
  createdAt            DateTime @default(now())
  adminNote            String?
  adminTags            String[] @default([])
  rejectReason         String?
  changesRequestedNote String?
  visibilityStatus     String   @default("published")
  moderationNote       String?
  complaintsCount      Int      @default(0)
  flagsCount           Int      @default(0)
  updatedAt            DateTime @updatedAt

  @@map("ProducerApplication")
}

model ProducerMessageRequest {
  id             String   @id @default(cuid())
  fromUserId     String
  producerUserId String
  message        String
  status         String   @default("pending")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  fromUser       User     @relation("ProducerMessageFrom", fields: [fromUserId], references: [id], onDelete: Cascade)
  producerUser   User     @relation("ProducerMessageTo", fields: [producerUserId], references: [id], onDelete: Cascade)

  @@index([producerUserId, status])
  @@index([fromUserId, producerUserId, status])
}

model ProducerThread {
  id                   String            @id @default(cuid())
  producerSlug         String
  producerUserId       String
  studentUserId        String
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  locked               Boolean           @default(false)
  complaintsCount      Int               @default(0)
  internalNote         String?
  investigationEnabled Boolean           @default(false)
  resolved             Boolean           @default(false)
  messages             ProducerMessage[]
  producerUser         User              @relation("ProducerThreadProducer", fields: [producerUserId], references: [id], onDelete: Cascade)
  studentUser          User              @relation("ProducerThreadStudent", fields: [studentUserId], references: [id], onDelete: Cascade)

  @@unique([producerSlug, studentUserId])
  @@index([producerUserId, updatedAt])
  @@index([studentUserId, updatedAt])
}

model ProducerMessage {
  id           String         @id @default(cuid())
  threadId     String
  senderRole   String
  senderUserId String?
  body         String
  createdAt    DateTime       @default(now())
  readAt       DateTime?
  thread       ProducerThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
  @@index([threadId, readAt])
}

model StudioThread {
  id                   String          @id @default(cuid())
  studioId             String
  studentUserId        String
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  locked               Boolean         @default(false)
  complaintsCount      Int             @default(0)
  internalNote         String?
  investigationEnabled Boolean         @default(false)
  resolved             Boolean         @default(false)
  messages             StudioMessage[]
  studentUser          User            @relation("StudioThreadStudent", fields: [studentUserId], references: [id], onDelete: Cascade)
  studio               Studio          @relation(fields: [studioId], references: [id], onDelete: Cascade)

  @@unique([studioId, studentUserId])
  @@index([studioId, updatedAt])
  @@index([studentUserId, updatedAt])
}

model StudioMessage {
  id           String       @id @default(cuid())
  threadId     String
  senderRole   String
  senderUserId String?
  body         String
  createdAt    DateTime     @default(now())
  readAt       DateTime?
  thread       StudioThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
  @@index([threadId, readAt])
}

model TeacherLead {
  id                  String   @id @default(cuid())
  teacherSlug         String
  teacherName         String?
  studentName         String
  studentEmail        String
  city                String
  preferredLessonType String?
  message             String
  status              String   @default("new")
  createdAt           DateTime @default(now())
  isRead              Boolean  @default(false)
}

model TeacherThread {
  id                   String           @id @default(cuid())
  teacherSlug          String
  teacherUserId        String
  studentUserId        String
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  locked               Boolean          @default(false)
  complaintsCount      Int              @default(0)
  internalNote         String?
  investigationEnabled Boolean          @default(false)
  resolved             Boolean          @default(false)
  messages             TeacherMessage[]
  studentUser          User             @relation("TeacherThreadStudent", fields: [studentUserId], references: [id], onDelete: Cascade)
  teacherUser          User             @relation("TeacherThreadTeacher", fields: [teacherUserId], references: [id], onDelete: Cascade)

  @@unique([teacherSlug, studentUserId])
  @@index([teacherUserId, updatedAt])
  @@index([studentUserId, updatedAt])
}

model TeacherMessage {
  id           String        @id @default(cuid())
  threadId     String
  senderRole   String
  senderUserId String?
  body         String
  createdAt    DateTime      @default(now())
  readAt       DateTime?
  thread       TeacherThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
  @@index([threadId, readAt])
}

model TeacherMessageRequest {
  id            String   @id @default(cuid())
  studentUserId String
  teacherUserId String
  teacherSlug   String
  messageText   String
  status        String   @default("pending")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  studentUser   User     @relation("TeacherMessageRequestStudent", fields: [studentUserId], references: [id], onDelete: Cascade)
  teacherUser   User     @relation("TeacherMessageRequestTeacher", fields: [teacherUserId], references: [id], onDelete: Cascade)

  @@index([teacherUserId, status])
  @@index([studentUserId, teacherUserId, status])
}

model TeacherStudioLink {
  id            String   @id @default(cuid())
  teacherUserId String
  studioId      String
  status        String   @default("pending")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  isRead        Boolean  @default(false)
  studio        Studio   @relation(fields: [studioId], references: [id], onDelete: Cascade)
  teacherUser   User     @relation(fields: [teacherUserId], references: [id], onDelete: Cascade)

  @@unique([teacherUserId, studioId])
  @@index([studioId, status])
  @@index([teacherUserId, status])
}

model ProducerStudioLink {
  id             String   @id @default(cuid())
  producerUserId String
  studioId       String
  status         String   @default("pending")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  isRead         Boolean  @default(false)
  producerUser   User     @relation(fields: [producerUserId], references: [id], onDelete: Cascade)
  studio         Studio   @relation(fields: [studioId], references: [id], onDelete: Cascade)

  @@unique([producerUserId, studioId])
  @@index([studioId, status])
  @@index([producerUserId, status])
}

model Lead {
  id        String   @id @default(cuid())
  name      String?
  email     String
  note      String?
  source    String?
  status    String   @default("new")
  createdAt DateTime @default(now())
  isRead    Boolean  @default(false)
}

model StudioContactEvent {
  id          String   @id @default(cuid())
  studioId    String
  userId      String?
  roomId      String?
  channel     String
  createdAt   DateTime @default(now())
  anonymousId String?
  studio      Studio   @relation(fields: [studioId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [userId], references: [id])

  @@index([studioId, createdAt])
  @@index([userId, createdAt])
}

model OpenJam {
  id                String              @id @default(cuid())
  createdByUserId   String
  studioId          String
  title             String
  note              String?
  genre             String?
  playlistLink      String?
  creatorLevel      String?
  startAt           DateTime
  durationMinutes   Int
  neededInstruments String[]
  city              String
  district          String?
  capacity          Int                 @default(5)
  status            String              @default("active")
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  createdByUser     User                @relation(fields: [createdByUserId], references: [id])
  studio            Studio              @relation(fields: [studioId], references: [id])
  participants      OpenJamParticipant[]
  messages          OpenJamMessage[]
  memories          OpenJamMemory[]

  @@index([studioId])
  @@index([city])
  @@index([startAt])
}

model OpenJamParticipant {
  id         String   @id @default(cuid())
  jamId      String
  userId     String
  instrument String?
  level      String?
  status     String   @default("joined")
  createdAt  DateTime @default(now())
  jam        OpenJam  @relation(fields: [jamId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([jamId, userId])
  @@index([jamId])
}

model OpenJamMessage {
  id        String   @id @default(cuid())
  jamId     String
  userId    String
  message   String
  createdAt DateTime @default(now())
  jam       OpenJam  @relation(fields: [jamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([jamId, createdAt])
}

model OpenJamMemory {
  id        String   @id @default(cuid())
  jamId     String
  userId    String
  text      String
  photoUrl  String?
  createdAt DateTime @default(now())
  jam       OpenJam  @relation(fields: [jamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  galleryImages OpenJamGalleryImage[]

  @@unique([jamId, userId])
  @@index([jamId, createdAt])
  @@index([userId, createdAt])
}

model OpenJamGalleryImage {
  id        String   @id @default(cuid())
  memoryId  String?
  photoUrl  String
  createdAt DateTime @default(now())
  memory    OpenJamMemory? @relation(fields: [memoryId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([memoryId])
}

model AdminAuditLog {
  id         String   @id @default(cuid())
  adminId    String
  entityType String
  entityId   String
  action     String
  before     Json?
  after      Json?
  createdAt  DateTime @default(now())
  metadata   Json?
}

model ContactEvent {
  id          String   @id @default(cuid())
  entityType  String
  entityId    String
  userId      String?
  roomId      String?
  anonymousId String?
  channel     String
  createdAt   DateTime @default(now())
  user        User?    @relation(fields: [userId], references: [id])

  @@index([entityType, entityId, createdAt])
  @@index([userId, createdAt])
  @@index([entityType, entityId, createdAt], map: "ContactEvent_entity_idx")
  @@index([userId, createdAt], map: "ContactEvent_user_idx")
}

model ContentBlock {
  id         String   @id @default(cuid())
  contentKey String   @unique
  title      String?
  body       String
  status     String   @default("draft")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model SystemFlag {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum UserRole {
  USER
  STUDIO
  ADMIN
}

enum SlotStatus {
  EMPTY
  CONFIRMED
}

enum PricingModel {
  FLAT
  DAILY
  HOURLY
  VARIABLE
}
